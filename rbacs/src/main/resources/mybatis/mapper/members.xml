<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.bogies.rbacs.dao.MembersDao">
	<resultMap type="org.bogies.common.entity.MembersEntity" id="memberInfo">
		<id property="id" column="id"/>
		<result property="username" column="username"/>
		<result property="password" column="password"/>
		<result property="nickname" column="nickname"/>
		<result property="sort" column="sort"/>
		<result property="createTime" column="create_time" jdbcType="DATE"/>
		<result property="updateTime" column="update_time" jdbcType="DATE"/>
		<result property="admin" column="is_admin"/>
		<result property="status" column="status"/>
	</resultMap>
	<resultMap type="org.bogies.common.entity.MembersEntity" id="memberBaseInfo">
		<id property="id" column="id"/>
		<result property="username" column="username"/>
		<result property="nickname" column="nickname"/>
		<result property="admin" column="is_admin"/>
		<result property="status" column="status"/>
	</resultMap>
	<insert id="insert">
		INSERT INTO members (id, username, password, nickname, sort, create_time, update_time, status) 
		VALUES (#{member.id},#{member.username},#{member.password},
		#{member.nickname},#{member.sort},#{member.createTime},
		#{member.updateTime},#{member.status})
	</insert>
	<delete id="deleteById">
		DELETE FROM members WHERE id=#{id}
	</delete>
	<select id="getUsers" resultMap="memberInfo">
        SELECT id,username,password,nickname,sort,create_time,update_time,is_admin,status FROM members m
        <if test="null!=filter">
	        <where>
	            <if test="filter.username!=null and filter.username!=''">
	                m.username=#{filter.username}
	            </if>
	            <if test="filter.nickname!=null and filter.nickname!=''">
	                and m.nickname=#{filter.nickname}
	            </if>
			</where>
		</if>
		ORDER BY sort
    </select>
    <select id="existByUsername" resultType="java.lang.Integer">
		SELECT count(*) FROM members WHERE username=#{username};
	</select>
    <select id="existOnlyAdmin" resultType="java.lang.Integer">
		SELECT count(*) FROM members WHERE is_admin='1' ;
	</select>
	<update id="updateByUsername">
		UPDATE members 
		SET 
			<if test="members.password!=null and members.password!=''">
				password=#{members.password},
			</if>
			nickname=#{members.nickname},
			sort=#{members.sort},
			create_time=#{members.createTime},
			update_time=#{members.updateTime},
			is_admin=#{members.isAdmin},
			status=#{members.status}
	 	WHERE userName=#{members.username}
	</update>
	<!-- 通过用户id获取用户信息 -->
	<select id="getById" resultMap="memberInfo">
		SELECT * FROM members WHERE id=#{id}
	</select>
	<!-- 通过用户名获取用户信息 -->
	<select id="getByUsername" resultMap="memberInfo">
		SELECT * FROM members WHERE username=#{username}
	</select>
	<!-- 根据用户名统计用户数量 -->
	<select id="countByUsername" resultType="Integer">
		SELECT count(id) uc FROM members where username=#{username}
	</select>
	<select id="findRoles" resultMap="org.bogies.rbacs.dao.RoleDao.roleInfo">
		select r.id,r.name from roles r 
		left join role_users ru on r.id=ru.role_id
		where ru.user_id=#{userId}
	</select>
	<delete id="clearUserRoles">
		DELETE FROM rbac_role_users WHERE user_id=#{userId}
	</delete>
</mapper>