<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.ants.rbacs.dao.ResourcesDao">
	<resultMap type="org.ants.rbacs.model.ResourcesModel" id="resourcesInfo">
		<id property="id" column="id"/>
		<result property="path" column="path"/>
		<result property="reqMethod" column="req_method"/>
		<result property="summary" column="summary"/>
		<result property="servicesName" column="services_name"/>
		<result property="description" column="description"/>
	</resultMap>
	
	<select id="selectAll" resultMap="resourcesInfo">
		SELECT id,type,path,req_method,summary,services_name,description FROM resources res
		<where>
			<if test='type!="" and type!=null'> and type=#{type} </if>
			<if test='path!="" and path!=null'> and path LIKE '%${path}%' </if>
			<if test='reqMethod!="" and reqMethod!=null'> and req_method=#{reqMethod} </if>
			<if test='summary!="" and summary!=null'> and summary LIKE '%${summary}%' </if>
			<if test='servicesName!="" and servicesName!=null'> and services_name=#{servicesName} </if>
			<if test='description!="" and description!=null'> and description LIKE '%#{description}%' </if>
		</where>
		ORDER BY res.services_name,res.path
	</select>
	<select id="checkPermitByUserId" resultType="java.lang.Integer">
        select count(*) from role_resources rr left join role_users ur ON
        rr.role_id=ur.role_id 
        where (rr.resource_id=#{resId}and ur.user_id=#{userId}) 
        or (rr.resource_id=#{resId} and rr.role_id=#{anonymousId})
	</select>
	<select id="checkPermitByRoleId" resultType="java.lang.Integer">
       select count(*) from role_resources rr
        where rr.resource_id=#{resId} 
        and (rr.role_id=#{roleId} or rr.role_id=#{anonymousId})
    </select>

	<insert id="insert" parameterType="java.util.List">
      	INSERT INTO resources (id,type,path,req_method,summary,services_name,description)
		VALUES
        <foreach collection="list" item="res" index="index" separator=",">
            (#{res.id},#{res.type},#{res.path},#{res.reqMethod},#{res.summary},#{res.servicesName},#{res.description})
        </foreach>
    </insert>
    
    <update id="updateById" parameterType="org.ants.rbacs.model.ResourcesModel">
    	UPDATE resources 
		SET
        	summary = #{summary} , description = #{description} 
        WHERE
        	id = #{id}
    </update>
     <update id="update" parameterType="org.ants.rbacs.model.ResourcesModel">
    	UPDATE resources 
		SET 
        	type = #{type},summary = #{summary}, services_name = #{servicesName} , description = #{description} 
       	WHERE
       		path = #{path} AND req_method = #{reqMethod}
    </update>
    <delete id="deleteById">
		DELETE FROM resources WHERE id=#{id}
	</delete>
  	<!-- Using path, req_method to determine whether a record exists -->
	<select id="existById" resultType="java.lang.Integer">
		SELECT count(*) FROM resources WHERE id=#{idMd5};
	</select>
</mapper>
